<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Order View - Trader System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.min.css" rel="stylesheet">

    <link href="css/font-awesome.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/jquery.jqplot.css" rel="stylesheet">

</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"><span
                    class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
            </a><a class="brand" href="index.html">Trader System </a>

            <div class="nav-collapse">
                <ul class="nav pull-right">
                    <li class="dropdown"><a href="Setting.html"><i
                            class="icon-cog"></i> Setting </a>
                    </li>
                    <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" id="userNameArea"><i
                            class="icon-user"></i> EGrappler.com <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="index.html">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
        <!-- /container -->
    </div>
    <!-- /navbar-inner -->
</div>
<!-- /navbar -->
<div class="subnavbar">
    <div class="subnavbar-inner">
        <div class="container">
            <ul class="mainnav">
                <li><a href="Order_New.html"><i class="icon-plus"></i><span>New Order</span> </a>
                </li>
                <li><a href="Order_Me.html"><i class="icon-list"></i><span>My Orders</span> </a>
                </li>
                <li><a href="Order_History.html"><i class="icon-calendar"></i><span>Order History</span> </a>
                </li>

            </ul>
        </div>
        <!-- /container -->
    </div>
    <!-- /subnavbar-inner -->
</div>

<!-- /subnavbar -->
<div class="main">
    <div class="main-inner">
        <div class="container" id="mainContainer">
            <div class="row">
                <div class="span12">
                    <div class="widget" style="overflow: visible">
                        <div class="widget-header"><i class="icon-dashboard"></i>

                            <h3>Search Orders</h3>
                        </div>
                        <!-- /widget-header -->
                        <div class="widget-content">
                            <div class="row" id="SearchOrders">
                                <div id="ConditionTable" class="span12 conditionDiv" hidden="">
                                    <div class="span2">
                                        <div class="btn-group">
                                            <a class="btn btn-info SearchCondition" data-toggle="dropdown"
                                               style="width : 90%; ">Condition:<i class="icon-chevron-down"> </i></a>
                                            <ul class="dropdown-menu">
                                                <li><a class="conditions">Product</a></li>
                                                <li><a class="conditions">Broker</a></li>
                                                <li><a class="conditions">Period</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="span4">
                                        <label>
                                            <input class="span4 inputKeyword" type="text" value="Input Keyword">
                                        </label>
                                    </div>
                                    <div class="span5">
                                        <button class="removeCondition btn btn-danger" onclick="">Remove</button>
                                        <button class="addCondition btn btn-info" onclick="">Add</button>
                                    </div>
                                </div>

                            </div>
                            <button class="btn btn-success btn-large" id="submitCondition" onclick="">Search</button>
                        </div>
                    </div>

                    <!-- TODO: Add Time-Price Chart -->
                    <div class="widget" style="overflow: visible">
                        <div class="widget-header"><i class="icon-dashboard"></i>

                            <h3>Graph</h3>
                        </div>
                        <!-- /widget-header -->
                        <div class="widget-content">
                            <div id="graph">

                            </div>
                        </div>
                    </div>


                    <div class="widget widget-table action-table" style="min-height: 100px;">
                        <div class="widget-header"><i class="icon-calendar"></i>

                            <h3>Search Result</h3>
                        </div>
                        <!-- /widget-header -->
                        <div class="widget-content">
                            <table class="table table-striped table-bordered" id="historyTable">
                                <thead>
                                <tr>
                                    <th> Trade ID</th>
                                    <th> Product</th>
                                    <th> Broker</th>
                                    <th> Period</th>
                                    <th> Price</th>
                                    <th> Quantity</th>
                                    <th> Dealer</th>
                                    <th> Purchaser</th>
                                    <th> Status</th>
                                    <th> Time</th>

                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <div class="form-actions" id="pageDiv">
                            <button class="btn btn-primary" data-toggle="modal" id="buttonPrev">Prev</button>
                            <button class="btn btn-primary" data-toggle="modal" id="buttonNext">Next</button>
                        </div>
                    </div>


                </div>

                <!-- /row -->
            </div>
            <!-- /container -->
        </div>
        <!-- /main-inner -->
    </div>
</div>

<div class="footer">
    <div class="footer-inner">
        <div class="container">
            <div class="row">
                <div class="span3"> Â© SJTU - School of Software Engineering</div>
                <!-- /span3 -->
                <div class="span3">
                    <h4>
                        Yifan Wang , 5120309065</h4>
                </div>
                <!-- /span3 -->
                <div class="span3">
                    <h4>
                        Zhida Yin , 5120379070</h4>
                </div>
                <!-- /span3 -->
                <div class="span3">
                    <h4>
                        Che Liu , 5120379066</h4>
                </div>
            </div>
            <!-- /row -->
        </div>
        <!-- /container -->
    </div>
    <!-- /footer-inner -->
</div>
<!-- /footer -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="js/jquery-1.7.2.min.js"></script>
<script src="js/excanvas.min.js"></script>
<script src="js/chart.min.js" type="text/javascript"></script>
<script src="js/bootstrap.js"></script>
<script src="js/base.js"></script>
<script src="js/commonFunc.js"></script>

<script src="js/jquery.jqplot.js"></script>
<script src="js/jqplot.cursor.js"></script>
<script src="js/jqplot.dateAxisRenderer.js"></script>
<script src="js/jqplot.highlighter.js"></script>


<script>
    var orderParsed = [];
    var itemsPerPage = getItemsPerPage();
    $(document).ready(function () {
        setUsernameLabel();
        addSearchCondition();

        function loadMyHistory(pageNum) {
            $("#historyTable").find('tbody').empty();
            var lenArr = orderParsed.length;
            for (var i = (pageNum - 1) * itemsPerPage; i < pageNum * itemsPerPage; i++) {
                if(i >= lenArr){
                    break;
                }
                var obj = orderParsed[i];
                $("#historyTable").find('tbody')
                        .append($('<tr>')
                                .append($('<td>').text(obj.id).attr("class", "orderID"))
                                .append($('<td>').text(obj.productname))
                                .append($('<td>').text(obj.broker))
                                .append($('<td>').text(obj.period))
                                .append($('<td>').text(obj.price).attr("class", "price"))
                                .append($('<td>').text(obj.amount))
                                .append($('<td>').text(obj.initiatorType === "buy" ? obj.completionTrader : obj.initiatorTrader ))
                                .append($('<td>').text(obj.initiatorType === "sell" ? obj.completionTrader : obj.initiatorTrader ))
                                .append($('<td>').text("Deal"))
                                .append($('<td>').text(obj.date_).attr("class", "time"))
                );
            }
        }

        function showGraph() {
            var priceList = [];
            var timeList = [];

            for(var i = 0 ; i < orderParsed.length ; i++){
                priceList.push(parseFloat(orderParsed[i].price) / parseInt(orderParsed[i].amount));
                timeList.push(orderParsed[i].date_);
            }
            /*
            $(".price").each(function () {
                priceList.push($(this).text());
            });
            $(".time").each(function () {
                timeList.push($(this).text());
            });
            */
            var data = [];
            var maxPrice = 0;
            var minPrice = 10000000000000;
            for (var i = 0; i < priceList.length; i++) {
                if (priceList[i] > maxPrice) {
                    maxPrice = priceList[i];
                }

                if (priceList[i] < minPrice) {
                    minPrice = priceList[i];
                }
                data.push([timeList[i], priceList[i]]);
            }

            $.jqplot("graph", [data], {
                title: 'Time-Price Curve',
                axes: {
                    xaxis: {
                        renderer: $.jqplot.DateAxisRenderer,
                        tickOptions: {
                            formatString: '%F'
                        },
                        label: "Date"
                    },
                    yaxis: {
                        tickOptions: {
                            formatString: '%.2f'
                        },
                        min: minPrice * 0.8,
                        max: maxPrice * 1.2,
                        label: "Price"
                    }
                },
                highlighter: {
                    show: true
                },
                cursor: {
                    show: true,
                    zoom: true,
                    showToolTip: true
                }
            });
        }

        $("#AddSearchCondition").click(function () {
            var searchDiv = $("#ConditionTable").clone();
            searchDiv.removeAttr("hidden");
            $("#SearchOrders").append(searchDiv);
        });

        $("#SearchOrders").on('click', '.removeCondition', function () {
            //Can not remove last search condition
            if ($("#SearchOrders").children(".conditionDiv").length == 2) {
                return;
            }
            $(this).parent().parent().remove();
        })
                .on('click', '.addCondition', function () {
                    addSearchCondition();
                }).on('click', '.conditions', function () {
                    var currentCondition = $(this).text();
                    var valid = true;
                    $(".SearchCondition").each(function () {
                        if($(this).text() === currentCondition){
                            valid = false;
                        }
                    });
                    if(valid){
                        $(this).parent().parent().parent().children(".SearchCondition").text(currentCondition);
                    }

                })
                .on('click', 'input[type=text]', function () {
                    $(this).val("");
                });

        $("#submitCondition").click(function () {
            var conditions = [];
            var strings = [];
            $(".SearchCondition").each(function () {
                conditions.push($(this).text());
            });
            $(".inputKeyword").each(function () {
                strings.push($(this).val());
            });
            var sendCondition = [];
            var broker = "";
            var product = "";
            var period = "";

            for (var i = 1; i < conditions.length; i++) {
                if (conditions[i] != null && conditions[i].length > 0 &&
                        strings[i] != null && strings[i].length > 0) {
                    var queryString = strings[i];
                    switch(conditions[i]){
                        case "Product":
                            product = queryString ;
                            break ;
                        case "Broker":
                            broker = queryString ;
                            break ;
                        case "Period":
                            period = queryString ;
                            break ;
                        default :
                            break;
                    }
                }
            }

            $.ajax({
                type: "POST",
                dataType: "json",
                url: "http://localhost:8080/searchHistory",
                data: {
                    broker: broker,
                    product : product,
                    period : period
                },
                success: function (data) {
                    hintSuccess("Query Complete.");
                    orderParsed = data;
                    loadPageButtons();
                    loadMyHistory(1);
                    showGraph();
                },
                error: function (data) {
                    hintError("Cannot connect to server");
                }
            });
        });


        function addSearchCondition() {
            var searchDiv = $("#ConditionTable").clone();
            searchDiv.removeAttr("hidden");
            $("#SearchOrders").append(searchDiv);
        }

        //Page selection
        $("#pageDiv").on('click', '.pageSelect', function () {
            var newPage = $(this).text();
            changePageButtons(newPage);
        });

        $("#buttonPrev").click(function () {
            var currentPage = $(".pageSelect:disabled").text();
            var pageNum = parseInt(currentPage, 10) - 1;
            changePageButtons(pageNum);
        });

        $("#buttonNext").click(function () {
            var currentPage = $(".pageSelect:disabled").text();
            var pageNum = parseInt(currentPage, 10) + 1;
            changePageButtons(pageNum);
        });

        function loadPageButtons() {
            var buttonCnt = Math.ceil(orderParsed.length / itemsPerPage);
            $(".pageSelect").remove();
            for (var i = 1; i <= buttonCnt; i++) {
                var button = $("<button>").attr("class", "btn pageSelect").attr("data-toggle", "model").text(i);
                if (i == 1) {
                    button.attr("disabled", "true");
                }
                $("#buttonNext").before(button);
            }
        }

        function changePageButtons(newIdx) {
            var buttonCnt = Math.ceil(orderParsed.length / itemsPerPage);
            if (newIdx <= 0 || newIdx > buttonCnt) {
                return;
            }
            $(".pageSelect:disabled").removeAttr('disabled');
            $(".pageSelect:contains(" + newIdx + ")").attr('disabled', "");
            loadMyHistory(newIdx);

        }
    });
</script>
</body>
</html>
