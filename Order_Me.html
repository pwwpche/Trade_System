<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Order View - Trader System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.min.css" rel="stylesheet">

    <link href="css/font-awesome.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"><span
                    class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
            </a><a class="brand" href="index.html">Trader System </a>

            <div class="nav-collapse">
                <ul class="nav pull-right">
                    <li class="dropdown"><a href="Setting.html"><i
                            class="icon-cog"></i> Setting </a>
                    </li>
                    <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" id="userNameArea"><i
                            class="icon-user"></i> <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="index.html">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
        <!-- /container -->
    </div>
    <!-- /navbar-inner -->
</div>
<!-- /navbar -->
<div class="subnavbar">
    <div class="subnavbar-inner">
        <div class="container">
            <ul class="mainnav">
                <li><a href="Order_New.html"><i class="icon-plus"></i><span>New Order</span> </a>
                </li>
                <li><a href="Order_Me.html"><i class="icon-list"></i><span>My Orders</span> </a>
                </li>
                <li><a href="Order_History.html"><i class="icon-calendar"></i><span>Order History</span> </a>
                </li>

            </ul>
        </div>
        <!-- /container -->
    </div>
    <!-- /subnavbar-inner -->
</div>
<!-- /subnavbar -->
<div class="main">
    <div class="main-inner">
        <div class="container" id="mainContainer">
            <div class="row">
                <div class="span12">

                    <div class="widget widget-table action-table" style="min-height: 400px;">
                        <div class="widget-header"><i class="icon-th-list"></i>

                            <h3>My Orders</h3>
                        </div>
                        <!-- /widget-header -->
                        <div class="widget-content">
                            <table class="table table-striped table-bordered" id="myOrders">
                                <thead>
                                <tr>
                                    <th> Order ID</th>
                                    <th> Product</th>
                                    <th> Broker</th>
                                    <th> Period</th>
                                    <th> Price</th>
                                    <th> Quantity</th>
                                    <th> Action</th>
                                    <th> Dealer</th>
                                    <th> Purchaser</th>
                                    <th> Status</th>
                                    <th> Time</th>
                                    <th class="td-actions">Cancel</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!--
                                <tr>
                                    <td class="orderID"> 00001</td>
                                    <td> Product 1</td>
                                    <td> Broker 2</td>
                                    <td> Period 2</td>
                                    <td> 12.5</td>
                                    <td> 20</td>
                                    <td> Buy</td>
                                    <td> user1</td>
                                    <td> Trader 1</td>
                                    <td> user2</td>
                                    <td> Broker 2</td>
                                    <td class="orderStatus"> Pending</td>
                                    <td> 2014-2-2 15:30:20</td>
                                    <td class="td-actions">
                                        <a class="btn btn-small btn-danger cancelOrder"><i class="icon-remove"> </i>
                                        </a>
                                    </td>
                                </tr>
                                -->

                                </tbody>
                            </table>
                        </div>
                        <div class="form-actions" id="pageDiv">
                            <!-- TODO: Add Page Selection-->
                            <button class="btn btn-primary" data-toggle="modal" id="buttonPrev">Prev</button>
                            <button class="btn btn-primary" data-toggle="modal" id="buttonNext">Next</button>
                        </div>
                    </div>
                </div>
                <!-- /row -->
            </div>

            <!-- Modal -->
            <div id="showOrder" class="modal hide fade" tabindex="-1" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-hidden="true">×
                        </button>
                        <h3>Order Information</h3>
                    </div>
                    <div class="modal-body">
                        <table class="table table-striped table-bordered" id="orderInfoTable">
                            <thead>
                            <tr>
                                <th> Order ID</th>
                                <th> Product</th>
                                <th> Broker</th>
                                <th> Period</th>
                                <th> Price</th>
                                <th> Quantity</th>
                                <th> Action</th>
                                <th> Dealer</th>
                                <th> Purchaser</th>
                                <th> Status</th>
                                <th> Time</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" data-dismiss="modal" aria-hidden="true">OK</button>
                    </div>
                </div>
            </div>

            <!-- /container -->
        </div>
        <!-- /main-inner -->
    </div>
</div>

<div class="footer">
    <div class="footer-inner">
        <div class="container">
            <div class="row">
                <div class="span3"> © SJTU - School of Software Engineering</div>
                <!-- /span3 -->
                <div class="span3">
                    <h4>
                        Yifan Wang , 5120309065</h4>
                </div>
                <!-- /span3 -->
                <div class="span3">
                    <h4>
                        Zhida Yin , 5120379070</h4>
                </div>
                <!-- /span3 -->
                <div class="span3">
                    <h4>
                        Che Liu , 5120379066</h4>
                </div>
            </div>
            <!-- /row -->
        </div>
        <!-- /container -->
    </div>
    <!-- /footer-inner -->
</div>
<!-- /footer -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="js/jquery-1.7.2.min.js"></script>
<script src="js/excanvas.min.js"></script>
<script src="js/chart.min.js" type="text/javascript"></script>
<script src="js/bootstrap.js"></script>
<script src="js/base.js"></script>
<script src="js/commonFunc.js"></script>
<script>
    //TODO: For testing, remove it
    var orderParsed = [];
    var itemsPerPage = getItemsPerPage();
    $(document).ready(function (event) {
        setUsernameLabel();
        loadOrders();

        function loadOrders() {
            var userName = getCookie("username");
            var depth = getCookie('depth') === "" ? 5 : getCookie('depth');
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "http://localhost:8080/getMyOrders",
                data: {
                    username : userName
                },
                success: function (data) {
                    orderParsed = data;

                    //Setup page selector
                    loadPageButtons();

                    //Set up order table
                    loadOrderTable(1);
                },
                error: function (data) {
                    hintError("Cannot load page data.");
                }
            });
        }

        function loadOrderTable(pageNum) {
            var lenArr = orderParsed.length;
            $("#myOrders").find('tbody').empty();
            for (var i = (pageNum - 1) * itemsPerPage; i < pageNum * itemsPerPage; i++) {
                if(i >= lenArr){
                    break;
                }

                var obj = orderParsed[i];

                var buttonStr = "";
                if (obj.status === "Pending" || obj.status === "Part") {
                    buttonStr = '<a class="btn btn-small btn-danger cancelOrder"><i class="icon-remove"> </i> </a>';
                }
                $("#myOrders").find('tbody')
                        .append($('<tr>')
                                .append($('<td>').text(obj.id).attr("class", "orderID"))
                                .append($('<td>').text(obj.productname))
                                .append($('<td>').text(obj.broker).attr("class", "orderBroker"))
                                .append($('<td>').text(obj.period))
                                .append($('<td>').text(obj.price))
                                .append($('<td>').text(obj.amount))
                                .append($('<td>').text(obj.initiatorType))
                                .append($('<td>').text(obj.initiatorType === "buy" ? obj.completionTrader : obj.initiatorTrader ))
                                .append($('<td>').text(obj.initiatorType === "sell" ? obj.completionTrader : obj.initiatorTrader ))
                                .append($('<td>').text(obj.status))
                                .append($('<td>').text(obj.date_))
                                .append($('<td>').html(buttonStr))
                );
            }
        }

        $("#showOrder").on('show.bs.modal', function () {
            $(this).css({
                width: '60%',
                left: '40%',
                height: 'auto'
            });
        });

        $("#myOrders").on('click', '.cancelOrder', function () {

            var thisElement = $(this);
            var broker = thisElement.parent().siblings(".orderBroker").text();
            var orderID = thisElement.parent().siblings(".orderID").text();
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "http://localhost:8080/cancelOrder",
                data: {
                    order_ID: orderID,
                    brokerName : broker
                },
                success: function (data) {
                    if(data.status === "success"){
                        for(var i = 0 ; i < orderParsed.length ; i++){
                            if(orderParsed[i].order_id === orderID){
                                orderParsed[i].status = "Canceled";
                                thisElement.parent().siblings(".orderStatus").text("Canceled");
                                thisElement.remove();
                                break;
                            }
                        }
                        hintSuccess("Order " + orderID  + " has been canceled.");
                    }else{
                        hintError(data.status + " : " + data.message);
                    }

                },
                error: function (data) {
                    hintError("Cannot connect to server.");
                }
            });

        })
                .on('click', '.orderID', function () {
                    var broker = $(this).siblings(".orderBroker").text();
                    showOrderDetail($(this).text(), broker);
                });

        //Show orders for the same transaction
        function showOrderDetail(orderId, broker) {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "http://localhost:8080/getOrderDetail",
                data: {
                    orderID : orderId ,
                    brokerName : broker
                },
                success: function (data) {
                    var arr = data;
                    var lenArr = arr.length;
                    for (var i = 0; i < lenArr; i++) {
                        var obj = arr[i];
                        $("#orderInfoTable").find('tbody')
                                .append($('<tr>')
                                        .append($('<td>').text(obj.id))
                                        .append($('<td>').text(obj.productname))
                                        .append($('<td>').text(obj.broker))
                                        .append($('<td>').text(obj.period))
                                        .append($('<td>').text(obj.price))
                                        .append($('<td>').text(obj.amount))
                                        .append($('<td>').text(obj.initiatorType))
                                        .append($('<td>').text(obj.initiatorType === "buy" ? obj.completionTrader : obj.initiatorTrader ))
                                        .append($('<td>').text(obj.initiatorType === "sell" ? obj.completionTrader : obj.initiatorTrader ))
                                        .append($('<td>').text(obj.status))
                                        .append($('<td>').text(obj.date_))
                        );
                    }

                },
                error: function (data) {
                    hintError("Cannot connect to server.");
                }
            });
            $("#showOrder").modal('show');
        }


        //Page selection
        $("#pageDiv").on('click', '.pageSelect', function(){
            var newPage = $(this).text();
            changePageButtons(newPage);
        });

        $("#buttonPrev").click(function(){
            var currentPage = $(".pageSelect:disabled").text();
            var pageNum = parseInt(currentPage, 10) - 1;
            changePageButtons(pageNum);
        });

        $("#buttonNext").click(function(){
            var currentPage = $(".pageSelect:disabled").text();
            var pageNum = parseInt(currentPage, 10) + 1;
            changePageButtons(pageNum);
        });

        function loadPageButtons() {
            var buttonCnt = Math.ceil(orderParsed.length / itemsPerPage);
            for (var i = 1; i <= buttonCnt; i++) {
                var button = $("<button>").attr("class", "btn pageSelect").attr("data-toggle", "model").text(i);
                if (i == 1) {
                    button.attr("disabled", "");
                }
                $("#buttonNext").before(button);
            }
        }

        function changePageButtons(newIdx){
            var buttonCnt = Math.ceil(orderParsed.length / itemsPerPage);
            if(newIdx <= 0 || newIdx > buttonCnt){
                return ;
            }
            $("#myOrders").find("tbody").find('tr').remove();
            $(".pageSelect:disabled").removeAttr('disabled');
            $(".pageSelect:contains(" + newIdx + ")").attr('disabled', "");
            //TODO: Load page content for new page
            loadOrderTable(newIdx);
        }
    });
</script>
</body>
</html>

<!-- 10.184.95.94 : 10080-->